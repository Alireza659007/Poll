<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<title>سیستم بازی با ثبت نام و جدول امتیازات</title>
<style>
  body { font-family: Tahoma, sans-serif; direction: rtl; max-width: 700px; margin: auto; padding: 20px; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; font-size: 16px; }
  .hidden { display: none; }
  #qrCanvas { margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
</style>
</head>
<body>

<h2>ثبت نام</h2>
<input id="regUsername" placeholder="نام کاربری" />
<input id="regPassword" type="password" placeholder="رمز عبور" />
<button onclick="registerUser()">ثبت نام</button>
<p id="regMsg" style="color:red"></p>

<hr />

<h2>ورود</h2>
<input id="loginUsername" placeholder="نام کاربری" />
<input id="loginPassword" type="password" placeholder="رمز عبور" />
<button onclick="loginUser()">ورود</button>
<p id="loginMsg" style="color:red"></p>

<hr />

<div id="userPanel" class="hidden">
  <h3>خوش آمدی، <span id="currentUserName"></span></h3>
  <p>موجودی دلار شما: <span id="balanceDisplay">0$</span></p>

  <h4>دریافت دلار با وارد کردن کد</h4>
  <input id="userCode" placeholder="کد را وارد کنید" />
  <button onclick="redeemCode()">دریافت دلار</button>
  <p id="redeemMsg" style="color:green"></p>

  <h4>انتقال دلار به کاربر دیگر</h4>
  <input id="transferTo" placeholder="نام کاربری گیرنده" />
  <input id="transferAmount" type="number" min="1" placeholder="مقدار دلار" />
  <button onclick="transferDollar()">انتقال</button>
  <p id="transferMsg" style="color:green"></p>

  <button onclick="logout()">خروج</button>

  <hr />

  <h3>جدول امتیازات</h3>
  <table id="scoreTable">
    <thead>
      <tr><th>رتبه</th><th>نام کاربری</th><th>موجودی دلار</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<hr />

<div id="adminLogin" >
  <h2>ورود به پنل لیدر</h2>
  <input id="adminPass" type="password" placeholder="رمز پنل لیدر" />
  <button onclick="loginAdmin()">ورود</button>
  <p id="adminMsg" style="color:red"></p>
</div>

<div id="adminPanel" class="hidden">
  <h3>پنل ساخت کدهای یکبار مصرف</h3>
  <input id="amountInput" type="number" min="1" placeholder="مقدار دلار (مثلاً 4)" />
  <button onclick="createCode()">ساخت کد جدید و QR</button>
  <div id="newCodeInfo"></div>
  <canvas id="qrCanvas"></canvas>
  <button onclick="logoutAdmin()">خروج از پنل لیدر</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // تنظیمات و ذخیره داده‌ها در localStorage
  const ADMIN_PASSWORD = "123098484skdA";
  let currentUser = null;

  // بارگذاری داده‌ها
  let users = JSON.parse(localStorage.getItem("users") || "{}");
  let codes = JSON.parse(localStorage.getItem("codes") || "{}");

  // ذخیره داده‌ها
  function saveData() {
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("codes", JSON.stringify(codes));
  }

  // ثبت نام
  function registerUser() {
    const u = document.getElementById("regUsername").value.trim();
    const p = document.getElementById("regPassword").value.trim();
    const msg = document.getElementById("regMsg");
    msg.innerText = "";

    if (!u || !p) {
      msg.innerText = "نام کاربری و رمز را وارد کنید";
      return;
    }
    if (users[u]) {
      msg.innerText = "نام کاربری قبلا استفاده شده";
      return;
    }
    users[u] = { password: p, balance: 0 };
    saveData();
    msg.style.color = "green";
    msg.innerText = "ثبت نام موفق! حالا وارد شوید";
    document.getElementById("regUsername").value = "";
    document.getElementById("regPassword").value = "";
  }

  // ورود کاربر
  function loginUser() {
    const u = document.getElementById("loginUsername").value.trim();
    const p = document.getElementById("loginPassword").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.innerText = "";

    if (!users[u]) {
      msg.innerText = "نام کاربری وجود ندارد";
      return;
    }
    if (users[u].password !== p) {
      msg.innerText = "رمز عبور اشتباه است";
      return;
    }

    currentUser = u;
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
    msg.innerText = "";
    showUserPanel();
  }

  // نمایش پنل کاربر
  function showUserPanel() {
    document.getElementById("userPanel").classList.remove("hidden");
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("currentUserName").innerText = currentUser;
    updateBalance();
    updateScoreTable();
  }

  // بروزرسانی موجودی
  function updateBalance() {
    if (!currentUser) return;
    document.getElementById("balanceDisplay").innerText = users[currentUser].balance + "$";
  }

  // ساخت کد تصادفی 20 رقمی
  function randomCode(length=20) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let code = "";
    for(let i=0; i<length; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // ساخت کد توسط پنل لیدر
  function createCode() {
    const amount = parseInt(document.getElementById("amountInput").value);
    if (!amount || amount < 1) {
      alert("مقدار دلار معتبر وارد کنید");
      return;
    }
    const code = randomCode();
    codes[code] = amount;
    saveData();

    document.getElementById("newCodeInfo").innerText = `کد ساخته شده: ${code}  مقدار: ${amount}$`;

    QRCode.toCanvas(document.getElementById("qrCanvas"), code, function (error) {
      if (error) console.error(error);
    });

    document.getElementById("amountInput").value = "";
  }

  // استفاده از کد برای دریافت دلار
  function redeemCode() {
    const code = document.getElementById("userCode").value.trim();
    const msg = document.getElementById("redeemMsg");
    msg.style.color = "green";
    msg.innerText = "";

    if (!currentUser) {
      msg.style.color = "red";
      msg.innerText = "ابتدا وارد حساب کاربری خود شوید.";
      return;
    }

    if (codes[code]) {
      const amount = codes[code];
      users[currentUser].balance += amount;
      delete codes[code];
      saveData();
      updateBalance();
      msg.innerText = `شما ${amount}$ دریافت کردید!`;
    } else {
      msg.style.color = "red";
      msg.innerText = "کد وارد شده اشتباه است یا قبلا استفاده شده.";
    }
    document.getElementById("userCode").value = "";
  }

  // انتقال دلار به کاربر دیگر
  function transferDollar() {
    const toUser = document.getElementById("transferTo").value.trim();
    const amount = parseInt(document.getElementById("transferAmount").value);
    const msg = document.getElementById("transferMsg");
    msg.style.color = "green";
    msg.innerText = "";

    if (!currentUser) {
      msg.style.color = "red";
      msg.innerText = "ابتدا وارد حساب کاربری خود شوید.";
      return;
    }
    if (!toUser || !users[toUser]) {
      msg.style.color = "red";
      msg.innerText = "کاربر گیرنده وجود ندارد.";
      return;
    }
    if (!amount || amount < 1) {
      msg.style.color = "red";
      msg.innerText = "مقدار معتبر وارد کنید.";
      return;
    }
    if (users[currentUser].balance < amount) {
      msg.style.color = "red";
      msg.innerText = "موجودی شما کافی نیست.";
      return;
    }

    users[currentUser].balance -= amount;
    users[toUser].balance += amount;
    saveData();
    updateBalance();
    msg.innerText = `موفقیت آمیز منتقل شد: ${amount}$ به ${toUser}`;
    document.getElementById("transferTo").value = "";
    document.getElementById("transferAmount").value = "";
    updateScoreTable();
  }

  // جدول امتیازات
  function updateScoreTable() {
    const tbody = document.querySelector("#scoreTable tbody");
    tbody.innerHTML = "";
    let sortable = [];
    for (const u in users) {
      sortable.push({ username: u, balance: users[u].balance });
    }
    sortable.sort((a,b) => b.balance - a.balance);

    sortable.forEach((user, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${index+1}</td><td>${user.username}</td><td>${user.balance}$</td>`;
      tbody.appendChild(tr);
    });
  }

  // پنل لیدر
  function loginAdmin() {
    const pass = document.getElementById("adminPass").value;
    const msg = document.getElementById("adminMsg");
    msg.innerText = "";
    if (pass === ADMIN_PASSWORD) {
      document.getElementById("adminPanel").classList.remove("hidden");
      document.getElementById("adminLogin").classList.add("hidden");
      document.getElementById("adminPass").value = "";
    } else {
      msg.innerText = "رمز اشتباه است!";
    }
  }
  function logoutAdmin() {
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("adminLogin").classList.remove("hidden");
  }

  // خروج کاربر
  function logout() {
    currentUser = null;
    document.getElementById("userPanel").classList.add("
